<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Extractor de Noticias</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .search-section {
            padding: 30px;
            background: #f8f9ff;
        }

        .search-container {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }

        .url-input {
            flex: 1;
            padding: 15px 20px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .url-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .search-btn {
            padding: 15px 30px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .search-btn:hover {
            transform: translateY(-2px);
        }

        .search-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .proxy-selector {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .proxy-option {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .proxy-option input[type="radio"] {
            width: 18px;
            height: 18px;
        }

        .results-section {
            padding: 30px;
            min-height: 200px;
        }

        .loading {
            text-align: center;
            padding: 40px;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .article {
            background: white;
            border: 1px solid #e1e5e9;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            transition: transform 0.2s ease;
        }

        .article:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }

        .article-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 15px;
            line-height: 1.4;
        }

        .article-meta {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            color: #666;
            font-size: 0.9rem;
        }

        .article-content {
            font-size: 1rem;
            line-height: 1.7;
            color: #444;
        }
        /* Fidelidad tipogr√°fica */
        .article-content p { margin: 0 0 1rem; }
        .article-content ul, .article-content ol { margin: 0 0 1rem 1.25rem; }
        .article-content li { margin: 0.25rem 0; }
        .article-content blockquote {
            margin: 0 0 1rem;
            padding-left: 12px;
            border-left: 4px solid #e5e7eb;
            color: #374151;
        }
        

        .error {
            background: #fee;
            border: 1px solid #fcc;
            color: #c33;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .success-info {
            background: #efe;
            border: 1px solid #cfc;
            color: #363;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .examples {
            margin-top: 20px;
            padding: 15px;
            background: white;
            border-radius: 10px;
            border: 1px solid #e1e5e9;
        }

        .examples h3 {
            margin-bottom: 10px;
            color: #667eea;
        }

        .example-url {
            display: block;
            color: #667eea;
            text-decoration: none;
            padding: 5px 0;
            font-size: 0.9rem;
        }

        .example-url:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üì∞ Extractor de Noticias</h1>
            <p>Extrae y visualiza contenido de noticias desde cualquier URL</p>
        </div>
        
        <div class="search-section">
            <div class="search-container">
                <input type="url" class="url-input" id="urlInput" placeholder="Ingresa la URL de la noticia aqu√≠..." />
                <button class="search-btn" id="searchBtn">üîç Extraer</button>
            </div>
            
            <div class="proxy-selector">
                <span><strong>M√©todo de extracci√≥n:</strong></span>
                <div class="proxy-option">
                    <input type="radio" id="allorigins" name="proxy" value="allorigins">
                    <label for="allorigins">AllOrigins</label>
                </div>
                <div class="proxy-option">
                    <input type="radio" id="corsproxy" name="proxy" value="corsproxy" checked>
                    <label for="corsproxy">CORS Proxy</label>
                </div>
                <div class="proxy-option">
                    <input type="radio" id="thingproxy" name="proxy" value="thingproxy">
                    <label for="thingproxy">ThingProxy</label>
                </div>
            </div>
            
            
        </div>
        
        <div class="results-section" id="results">
            <p style="text-align: center; color: #666; font-style: italic;">
                Ingresa una URL de noticia y selecciona un m√©todo de extracci√≥n para comenzar
            </p>
        </div>
    </div>

    <script>
        class NewsExtractor {
            constructor() {
                this.urlInput = document.getElementById('urlInput');
                this.searchBtn = document.getElementById('searchBtn');
                this.results = document.getElementById('results');
                
                this.proxies = {
                    allorigins: 'https://api.allorigins.win/get?url=',
                    corsproxy: 'https://corsproxy.io/?',
                    thingproxy: 'https://thingproxy.freeboard.io/fetch/'
                };
                
                this.bindEvents();
            }
            
            bindEvents() {
                this.searchBtn.addEventListener('click', () => this.extractNews());
                this.urlInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.extractNews();
                });
                
                // Manejar URLs de ejemplo
                document.querySelectorAll('.example-url').forEach(link => {
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        this.urlInput.value = e.target.getAttribute('data-url');
                        this.extractNews();
                    });
                });

                // Abrir enlaces del resultado en modal
                this.results.addEventListener('click', (e) => {
                    const anchor = e.target.closest('a[href]');
                    if (!anchor) return;
                    if (anchor.closest('#originalBar')) return; // la barra fija mantiene nueva pesta√±a
                    const href = anchor.getAttribute('href');
                    if (!href || href.startsWith('javascript:')) return;
                    try {
                        const abs = new URL(href, location.href);
                        const host = abs.hostname.toLowerCase();
                        if (/(^|\.)twitter\.com$/.test(host) || /(^|\.)x\.com$/.test(host) || /(^|\.)t\.co$/.test(host) || /twimg\.com$/.test(host) || /pbs\.twimg\.com$/.test(host) || /video\.twimg\.com$/.test(host)) {
                            e.preventDefault();
                            return;
                        }
                    } catch {}
                    e.preventDefault();
                    ensureLinkModal(href, anchor.textContent || href);
                });
            }
            
            getSelectedProxy() {
                const el = document.querySelector('input[name="proxy"]:checked');
                return el ? el.value : 'corsproxy';
            }
            
            showLoading() {
                this.results.innerHTML = `
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Extrayendo contenido de la noticia...</p>
                    </div>
                `;
                this.searchBtn.disabled = true;
                this.searchBtn.textContent = '‚è≥ Extrayendo...';
            }
            
            hideLoading() {
                this.searchBtn.disabled = false;
                this.searchBtn.textContent = 'üîç Extraer';
            }
            
            async fetchWithProxy(url, proxyType) {
                const proxy = this.proxies[proxyType];
                let fetchUrl;
                
                switch(proxyType) {
                    case 'allorigins':
                        fetchUrl = proxy + encodeURIComponent(url);
                        break;
                    case 'corsproxy':
                        fetchUrl = proxy + encodeURIComponent(url);
                        break;
                    case 'thingproxy':
                        fetchUrl = proxy + url;
                        break;
                }
                
                const response = await fetch(fetchUrl);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.text();
                
                // AllOrigins devuelve JSON, los otros devuelven HTML directo
                if (proxyType === 'allorigins') {
                    const jsonData = JSON.parse(data);
                    return jsonData.contents;
                }
                
                return data;
            }
            
            extractArticleContent(html) {
                // Crear un documento temporal para parsear el HTML
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                // Omitir todo lo que est√© dentro de <script type="text/javascript">
                removeTextJavaScriptScripts(doc);
                
                // Intentar extraer diferentes elementos
                const article = {
                    title: this.extractTitle(doc),
                    content: this.extractContent(doc),
                    meta: this.extractMeta(doc),
                    summary: this.extractSummary(doc)
                };
                
                return article;
            }
            
            extractTitle(doc) {
                // Buscar t√≠tulo en diferentes selectores
                const selectors = [
                    'h1[class*="title"]',
                    'h1[class*="headline"]',
                    '.article-title',
                    '.entry-title',
                    'h1',
                    'title'
                ];
                
                for (const selector of selectors) {
                    const element = doc.querySelector(selector);
                    if (element && element.textContent.trim()) {
                        return element.textContent.trim();
                    }
                }
                
                return 'T√≠tulo no encontrado';
            }
            
            extractContent(doc) {
                // Selectores comunes para contenido de art√≠culos
                const selectors = [
                    '.article-content',
                    '.entry-content',
                    '.post-content',
                    '[class*="article-body"]',
                    '[class*="story-body"]',
                    '.content',
                    'main p'
                ];
                
                for (const selector of selectors) {
                    const elements = doc.querySelectorAll(selector);
                    if (elements.length > 0) {
                        const content = Array.from(elements)
                            .map(el => el.textContent.trim())
                            .filter(text => text.length > 50)
                            .join('\n\n');
                        
                        if (content) return content;
                    }
                }
                
                // Fallback: extraer todos los p√°rrafos
                const paragraphs = doc.querySelectorAll('p');
                const content = Array.from(paragraphs)
                    .map(p => p.textContent.trim())
                    .filter(text => text.length > 30)
                    .slice(0, 10) // Limitar a 10 p√°rrafos
                    .join('\n\n');
                
                return content || 'Contenido no encontrado';
            }
            
            extractMeta(doc) {
                const meta = {};
                
                // Autor
                const authorSelectors = [
                    '[name="author"]',
                    '.author',
                    '.byline',
                    '[class*="author"]'
                ];
                
                for (const selector of authorSelectors) {
                    const element = doc.querySelector(selector);
                    if (element) {
                        meta.author = element.getAttribute('content') || element.textContent.trim();
                        break;
                    }
                }
                
                // Fecha
                const dateSelectors = [
                    '[name="publish-date"]',
                    '[property="article:published_time"]',
                    '.date',
                    'time',
                    '[class*="date"]'
                ];
                
                for (const selector of dateSelectors) {
                    const element = doc.querySelector(selector);
                    if (element) {
                        meta.date = element.getAttribute('content') || 
                                   element.getAttribute('datetime') || 
                                   element.textContent.trim();
                        break;
                    }
                }
                
                return meta;
            }
            
            extractSummary(doc) {
                const summarySelectors = [
                    '[name="description"]',
                    '[property="og:description"]',
                    '.summary',
                    '.excerpt',
                    '.lead'
                ];
                
                for (const selector of summarySelectors) {
                    const element = doc.querySelector(selector);
                    if (element) {
                        const summary = element.getAttribute('content') || element.textContent.trim();
                        if (summary && summary.length > 20) {
                            return summary;
                        }
                    }
                }
                
                return null;
            }
            
            displayArticle(article, url, proxyUsed) {
                const esc = (s) => String(s)
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;');
                const rawParas = Array.isArray(article.bodyParagraphsHtml) && article.bodyParagraphsHtml.length
                    ? article.bodyParagraphsHtml
                    : (Array.isArray(article.bodyParagraphs) ? article.bodyParagraphs.map(p => esc(p).replace(/\n/g,'<br>')) : (article.content ? article.content.split(/\n{2,}/).map(p => esc(p.trim()).replace(/\n/g,'<br>')).filter(Boolean) : []));
                const paragraphsHtml = rawParas.length
                    ? rawParas.map(p => `<p>${p}</p>`).join('')
                    : '<p>Contenido no encontrado</p>';

                this.results.innerHTML = `
                    <div class="article">
                        <h2 class="article-title" style="text-align:center;font-size:2rem;">${article.title}</h2>

                        ${(article.meta.author || article.meta.date) ? `
                        <div style="border-left:6px solid #22c55e;background:#f0fdf4;padding:10px 12px;margin:10px 0;border-radius:6px 4px 4px 6px;color:#065f46;display:flex;gap:12px;align-items:center;justify-content:space-between;">
                            <div style="flex:1 1 auto;">
                                <div><strong>Autor:</strong> ${article.meta.author || 'No disponible'}</div>
                                <div><strong>Fecha:</strong> ${(function(){
                                    const v = article.meta.date; 
                                    if (!v) return '';
                                    const d = new Date(v);
                                    if (isNaN(d.getTime())) return `${v}`;
                                    const pad = (n)=>String(n).padStart(2,'0');
                                    return `${pad(d.getDate())}-${pad(d.getMonth()+1)}-${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
                                })()}</div>
                            </div>
                            ${article.authorPhoto ? `<img src="${article.authorPhoto}" alt="autor" style="width:72px;height:72px;border-radius:50%;object-fit:cover;border:3px solid #22c55e;"/>` : ''}
                        </div>` : ''}

                        ${article.subtitle ? `<div class="article-subtitle" style="font-size:1.1rem;color:#374151;margin:8px 0 6px;">${article.subtitle}</div>` : ''}
                        ${article.subtitleLinkHtml ? `<div style="margin:0 0 12px;">${article.subtitleLinkHtml}</div>` : ''}
                        
                        ${Array.isArray(article.images) && article.images.length ? `
                            <figure style="margin:10px 0;">
                                <img src="${(typeof article.images[0]==='string'?article.images[0]:article.images[0].url)}" alt="imagen" style="width:100%;height:auto;border-radius:8px;"/>
                                ${(typeof article.images[0]==='object' && article.images[0].caption) ? `<figcaption style="font-size:0.8rem;color:#6b7280;margin-top:6px;">${article.images[0].caption}</figcaption>` : ''}
                            </figure>
                        ` : ''}
                        ${Array.isArray(article.images) && article.images.length > 1 ? `
                            <div style="margin-top:6px;display:flex;flex-wrap:wrap;gap:8px;">
                                ${article.images.slice(1).map(img => {
                                    const u = (typeof img==='string'?img:img.url);
                                    const c = (typeof img==='object' && img.caption) ? img.caption : '';
                                    return `<figure style='width:160px;flex:0 0 auto;'>
                                                <img src='${u}' alt='img' style='width:100%;height:auto;border-radius:6px;'/>
                                                ${c ? `<figcaption style=\'font-size:0.75rem;color:#6b7280;margin-top:4px;\'>${c}</figcaption>` : ''}
                                            </figure>`;
                                }).join('')}
                            </div>
                        ` : ''}

                        ${article.summary ? `<div style="background: #f8f9ff; padding: 15px; border-left: 4px solid #667eea; margin-bottom: 20px; border-radius: 5px;"><strong>Resumen:</strong> ${article.summary}</div>` : ''}
                        
                        <div class="article-content">${paragraphsHtml}</div>

                        ${Array.isArray(article.videos) && article.videos.length ? `<div style=\"margin-top:12px;\"><strong>V√≠deos:</strong><ul style=\"margin-top:6px;padding-left:18px;\">${article.videos.map(u => `<li><a href='${u}' target='_blank'>${u}</a></li>`).join('')}</ul></div>` : ''}
                    </div>
                `;

                // Asegurar barra fija inferior con enlace
                ensureOriginalBar(url);
            }
            
            displayError(error, url) {
                this.results.innerHTML = `
                    <div class="error">
                        <h3>‚ùå Error al extraer la noticia</h3>
                        <p><strong>URL:</strong> ${url}</p>
                        <p><strong>Error:</strong> ${error}</p>
                        <p style="margin-top: 15px;">
                            üí° <strong>Sugerencias:</strong><br>
                            ‚Ä¢ Prueba con un m√©todo de extracci√≥n diferente<br>
                            ‚Ä¢ Verifica que la URL sea correcta y accesible<br>
                            ‚Ä¢ Algunos sitios web bloquean el scraping
                        </p>
                    </div>
                `;
            }
            
            async extractNews() {
                const url = this.urlInput.value.trim();
                
                if (!url) {
                    alert('Por favor, ingresa una URL v√°lida');
                    return;
                }
                
                if (!this.isValidUrl(url)) {
                    alert('Por favor, ingresa una URL v√°lida (debe comenzar con http:// o https://)');
                    return;
                }
                
                const proxyType = this.getSelectedProxy();
                
                this.showLoading();
                
                try {
                    const html = await this.fetchWithProxy(url, proxyType);
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    // Omitir todo lo que est√© dentro de <script type="text/javascript">
                    removeTextJavaScriptScripts(doc);
                    const hostname = new URL(url).hostname.toLowerCase().replace(/^www\./, '');

                    if (hostname.endsWith('abc.es')) {
                        const data = extractByProfile(doc, url, ABC_PROFILE);
                        const article = {
                            title: data.title || 'T√≠tulo no encontrado',
                            content: (data.bodyParagraphs || []).join('\n\n') || 'Contenido no encontrado',
                            meta: {
                                author: data.author || '',
                                date: data.updatedAt || data.publishedAt || ''
                            },
                            summary: null,
                            subtitle: data.subtitle || '',
                            subtitleLinkHtml: data.subtitleLinkHtml || '',
                            images: data.images || [],
                            bodyParagraphs: data.bodyParagraphs || [],
                            bodyParagraphsHtml: data.bodyParagraphsHtml || [],
                            authorPhoto: data.authorPhoto || '',
                            videos: data.videos || []
                        };
                        this.displayArticle(article, url, proxyType.toUpperCase());
                    } else if (hostname.endsWith('elpais.com')) {
                        const data = extractByProfile(doc, url, ELPAIS_PROFILE);
                        const article = {
                            title: data.title || 'T√≠tulo no encontrado',
                            content: (data.bodyParagraphs || []).join('\n\n') || 'Contenido no encontrado',
                            meta: {
                                author: data.author || '',
                                date: data.updatedAt || data.publishedAt || ''
                            },
                            summary: null,
                            subtitle: data.subtitle || '',
                            subtitleLinkHtml: data.subtitleLinkHtml || '',
                            images: data.images || [],
                            bodyParagraphs: data.bodyParagraphs || [],
                            bodyParagraphsHtml: data.bodyParagraphsHtml || [],
                            authorPhoto: data.authorPhoto || '',
                            videos: data.videos || []
                        };
                        this.displayArticle(article, url, proxyType.toUpperCase());
                    } else {
                        const article = this.extractArticleContent(html);
                        this.displayArticle(article, url, proxyType.toUpperCase());
                    }
                } catch (error) {
                    console.error('Error:', error);
                    this.displayError(error.message, url);
                } finally {
                    this.hideLoading();
                }
            }
            
            isValidUrl(string) {
                try {
                    new URL(string);
                    return true;
                } catch (_) {
                    return false;
                }
            }
        }

        // Modal para visualizar enlaces en ventana emergente
        function ensureLinkModal(url, titleText) {
            let overlay = document.getElementById('linkModal');
            if (!overlay) {
                overlay = document.createElement('div');
                overlay.id = 'linkModal';
                overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.6);display:none;z-index:2147483647;';
                const container = document.createElement('div');
                container.id = 'linkModalContainer';
                container.style.cssText = 'position:absolute;top:5%;left:50%;transform:translateX(-50%);width:90%;height:90%;max-width:1100px;background:#fff;border-radius:8px;overflow:hidden;display:flex;flex-direction:column;';
                const header = document.createElement('div');
                header.style.cssText = 'padding:10px 12px;display:flex;align-items:center;justify-content:space-between;background:#111827;color:#fff;';
                const title = document.createElement('span');
                title.id = 'linkModalTitle';
                title.style.cssText = 'font-size:0.9rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;';
                const closeBtn = document.createElement('button');
                closeBtn.id = 'linkModalClose';
                closeBtn.textContent = '‚úñ';
                closeBtn.style.cssText = 'background:transparent;border:0;color:#fff;font-size:1rem;cursor:pointer;padding:6px;';
                header.appendChild(title);
                header.appendChild(closeBtn);
                const frame = document.createElement('iframe');
                frame.id = 'linkModalFrame';
                frame.style.cssText = 'border:0;width:100%;flex:1;';
                container.appendChild(header);
                container.appendChild(frame);
                overlay.appendChild(container);
                document.body.appendChild(overlay);

                // Cierre
                closeBtn.addEventListener('click', () => hideLinkModal());
                overlay.addEventListener('click', (e) => { if (e.target === overlay) hideLinkModal(); });
                document.addEventListener('keydown', (e) => { if (e.key === 'Escape') hideLinkModal(); });
            }
            const titleEl = document.getElementById('linkModalTitle');
            const frameEl = document.getElementById('linkModalFrame');
            if (titleEl) titleEl.textContent = titleText || url;
            if (frameEl) frameEl.src = url;
            overlay.style.display = 'block';
        }

        function hideLinkModal() {
            const overlay = document.getElementById('linkModal');
            const frameEl = document.getElementById('linkModalFrame');
            if (frameEl) frameEl.src = 'about:blank';
            if (overlay) overlay.style.display = 'none';
        }

        // Crea o actualiza la barra fija inferior con enlace a la noticia original
        function ensureOriginalBar(url) {
            let bar = document.getElementById('originalBar');
            if (!bar) {
                bar = document.createElement('div');
                bar.id = 'originalBar';
                bar.style.position = 'fixed';
                bar.style.left = '0';
                bar.style.right = '0';
                bar.style.bottom = '0';
                bar.style.background = '#111827';
                bar.style.color = '#fff';
                bar.style.padding = '12px 16px';
                bar.style.boxShadow = '0 -2px 10px rgba(0,0,0,0.15)';
                bar.style.display = 'flex';
                bar.style.justifyContent = 'center';
                bar.style.zIndex = '2147483647'; // max z-index para asegurar visibilidad
                document.body.appendChild(bar);
            }
            bar.innerHTML = `<a href="${url}" target="_blank" rel="noopener noreferrer" style="color:#fff;text-decoration:none;font-weight:600;">Ver la noticia original</a>`;
        }
        
        // Elimina del DOM todos los <script type="..."> y su contenido (cualquier tipo)
        function removeTextJavaScriptScripts(doc) {
            try {
                const scripts = doc.querySelectorAll('script[type]');
                scripts.forEach(s => { s.remove(); });
            } catch {}
        }
        
        // =================
        //       ABC
        // =================
        const ABC_PROFILE = {
            domain: 'www.abc.es',
            subtituloClasses: [ 'voc-subtitle' ],
            autorClasses: [ 'voc-author', 'voc-author__item--1' ],
            fechaPublicacionClasses: [ 'voc-author__time' ],
            fechaActualizacionClasses: [],
            imagenesClasses: [
                'voc-header__img',
                'voc-header__img--abc',
                'voc-header__buttons--img',
                'gigya-user-thumbnail',
                'voc-img-figure',
                'voc-img',
                'voc-author__image',
                'voc-author__img',
                'logo-premium',
                'voc-most-read__item-media',
                'voc-heading__img',
            ],
            videosClasses: [],
            excluirPublicidadClasses: [
                'voc-modal-dropdown',
                'voc-share-social',
                'voc-modal-dropdown--negative',
                'voc-save-news',
                'voc-btn',
                'voc-btn--bdr',
                'voc-btn--has-icon',
                'voc-btn--has-icon--right',
                'voc-d-c-related-news',
                'voc-d-c__header',
                'voc-grid--2-cols',
                '.voc-c-container.voc-c-container--w-col-ab.voc-c-container--bdr',
                'nibara-element'
            ],
            contenedorPrincipalClasses: [
                'voc-d__article',
                'voc-article',
                'voc-article--c-related-news',
                'voc-article--photo-right',
                'voc-article--swiss',
                'voc-article--swiss-secondary',
                'voc-article--photo-top'
            ]
        };

        // =================
        //     EL PA√çS
        // =================
        const ELPAIS_PROFILE = {
            domain: 'elpais.com',
            subtituloClasses: [ 'a_st', 'me-dis_t', 'enc', 'c_t' ],
            autorClasses: [],
            fechaPublicacionClasses: [ 'c_da' ],
            fechaActualizacionClasses: [],
            imagenesClasses: [ 'ep_i', 'a_m', 'a_m-h', '_re', 'a_md_i', 'c_m--nf', 'lazyload', 'w-sea_f' ],
            videosClasses: [],
            excluirPublicidadClasses: [ 'ad', 'ad-giga', 'ad-giga-1', 'ad-ldb', 'ad-ldb-1', 'ad-mldb', 'ad-mldb-1', 'x-ph', 'x-ph-nf', 'ed_a', 'pb_p', 'ad-nstd-bd', '_df', 'btn', 'ad-mpu', 'ad-giga-2', 'ad-ldb-2', 'ad-mldb-2' ],
            contenedorPrincipalClasses: [ 'a', '_g', '_g-lg', '_g-o', 'c', 'c--m-n' ]
        };

        // Utilidad: extraer mediante perfil de clases + metadatos de respaldo (JSON-LD/meta)
        function extractByProfile(doc, baseUrl, profile) {
            const $ = (sel, ctx = doc) => ctx.querySelector(sel);
            const $$ = (sel, ctx = doc) => Array.from(ctx.querySelectorAll(sel));
            const txt = (el) => (el ? el.textContent.trim() : '');
            const resolveUrl = (u) => { try { return new URL(u, baseUrl).toString(); } catch { return ''; } };
            const meta = (p, v) => { const m = doc.querySelector(`meta[${p}="${v}"]`); return m ? (m.getAttribute('content') || '').trim() : ''; };
            const cleanAuthorText = (s) => {
                let t = (s || '').replace(/\s+/g, ' ').trim();
                if (!t) return t;
                const killers = [
                    /esta funcionalidad/i,
                    /iniciar sesi[√≥o]n/i,
                    /suscrib/i,
                    /compartir/i,
                    /copiar enlace/i,
                    /facebook/i,
                    /\bX\b/i,
                    /whatsapp/i,
                    /email/i
                ];
                for (const r of killers) {
                    const m = t.match(r);
                    if (m && m.index !== undefined) {
                        t = t.slice(0, m.index).trim();
                    }
                }
                // Cortar antes de d√≠gitos (suelen ser fechas/horas)
                const idxDigit = t.search(/[0-9]/);
                if (idxDigit > 1) t = t.slice(0, idxDigit).trim();
                // Quitar prefijo "por " y separadores finales
                t = t.replace(/^por\s+/i, '').replace(/[|¬∑‚Ä¢‚Äî-]\s*$/,'').trim();
                return t;
            };
            const ALLOWED_TAGS = new Set(['A','B','STRONG','I','EM','U','BR','BLOCKQUOTE']);
            const isTwitterLike = (url) => /(^https?:\/\/)?([\w-]+\.)*(twitter\.com|x\.com|t\.co|twimg\.com|pbs\.twimg\.com|video\.twimg\.com)\//i.test(url || '');
            const isAdCode = (html) => /(googletag|defineSlot|getAdSiteId|pubads\(|sizeMapping|doubleclick|windowWidth\s*=|ads?-x\d+)/i.test(html || '');
            const sanitizeNode = (node) => {
                if (node.nodeType === Node.TEXT_NODE) return node.textContent;
                if (node.nodeType !== Node.ELEMENT_NODE) return '';
                const el = node;
                const tag = el.tagName;
                if (tag === 'SCRIPT' || tag === 'STYLE' || tag === 'IFRAME' || tag === 'OBJECT') return '';
                if (ALLOWED_TAGS.has(tag)) {
                    if (tag === 'A') {
                        let href = el.getAttribute('href') || '';
                        if (href.startsWith('javascript:')) href = '';
                        const safeHref = href ? resolveUrl(href) : '';
                        const inner = Array.from(el.childNodes).map(sanitizeNode).join('');
                        if (!safeHref) return inner;
                        if (isTwitterLike(safeHref)) return '';
                        return `<a href="${safeHref}" target="_blank" rel="noopener noreferrer">${inner}</a>`;
                    }
                    // Other inline tags: rebuild with same tag and sanitized children
                    const inner = Array.from(el.childNodes).map(sanitizeNode).join('');
                    if (tag === 'BLOCKQUOTE') {
                        return `<blockquote>${inner}</blockquote>`;
                    }
                    return `<${tag.toLowerCase()}>${inner}</${tag.toLowerCase()}>`;
                }
                if (tag === 'SPAN') {
                    // Unwrap spans but keep children
                    return Array.from(el.childNodes).map(sanitizeNode).join('');
                }
                // For unknown tags, keep sanitized children content only
                return Array.from(el.childNodes).map(sanitizeNode).join('');
            };
            const sanitizeParagraphInnerHtml = (el) => Array.from(el.childNodes).map(sanitizeNode).join('');
            const pickBestFromSrcset = (srcset) => {
                if (!srcset) return '';
                // Split by commas, parse candidates of form "url widthw" or "url densityx"
                const candidates = srcset.split(',').map(s => s.trim()).map(item => {
                    const parts = item.split(/\s+/);
                    if (!parts.length) return null;
                    const url = parts[0];
                    const descriptor = parts[1] || '';
                    let score = 0;
                    const mW = descriptor.match(/(\d+)w/);
                    const mX = descriptor.match(/([\d.]+)x/);
                    if (mW) score = parseInt(mW[1], 10);
                    else if (mX) score = parseFloat(mX[1]) * 1000; // approximate
                    return { url, score };
                }).filter(Boolean);
                if (!candidates.length) return '';
                candidates.sort((a,b) => b.score - a.score);
                return candidates[0].url;
            };
            const bestImageUrl = (img) => {
                if (!img) return '';
                // Try from <img>
                const srcset = img.getAttribute('srcset') || img.getAttribute('data-srcset');
                const bestFromImg = pickBestFromSrcset(srcset);
                const src = img.getAttribute('src') || img.getAttribute('data-src') || img.getAttribute('data-lazy-src') || img.getAttribute('data-original') || img.getAttribute('data-hires');
                let candidate = bestFromImg || src || '';
                if (candidate) return resolveUrl(candidate);
                // Try from enclosing <picture><source>
                const picture = img.closest('picture');
                if (picture) {
                    const source = picture.querySelector('source[srcset], source[data-srcset]');
                    if (source) {
                        const sset = source.getAttribute('srcset') || source.getAttribute('data-srcset');
                        const bestFromSource = pickBestFromSrcset(sset);
                        if (bestFromSource) return resolveUrl(bestFromSource);
                    }
                }
                return '';
            };
            const normalizeImageKey = (u) => {
                try { const x = new URL(u, baseUrl); return `${x.origin}${x.pathname}`; } catch { return u || ''; }
            };

            // JSON-LD respaldo
            const parseJSONLD = () => {
                for (const s of $$('script[type="application/ld+json"]')) {
                    try {
                        const data = JSON.parse(s.textContent);
                        const arr = Array.isArray(data) ? data : [data];
                        for (const it of arr) {
                            if (!it || typeof it !== 'object') continue;
                            const t = (it['@type'] || it.type || '').toString().toLowerCase();
                            if (t.includes('newsarticle') || t.includes('article')) return it;
                        }
                    } catch {}
                }
                return null;
            };
            const jsonld = parseJSONLD();

            // Contenedor principal
            let container = null;
            for (const cls of (profile.contenedorPrincipalClasses || [])) {
                const node = $(`.${cls}`);
                if (node) { container = node; break; }
            }
            if (!container) container = doc.body;

            // Exclusi√≥n de publicidad/elementos no editoriales
            const EXCLUDES = [ 'figure', 'figcaption', "[class*='advertising']" ].concat(profile.excluirPublicidadClasses || []);
            const normalizeSel = (sel) => sel.startsWith('.') || sel.startsWith('[') ? sel : `.${sel}`;
            const isExcluded = (el) => EXCLUDES.some(sel => el.closest(normalizeSel(sel)));
            const isAdOrUi = (el) => (["[class*='advertising']"].concat(profile.excluirPublicidadClasses || [])).some(sel => el.closest(normalizeSel(sel)));

            // T√≠tulo
            let title = txt(container.querySelector('h1, [class*="title"], [class*="headline"]')) || txt($('.voc-title')) || meta('property', 'og:title');

            // Subt√≠tulo y posible bloque con enlace justo debajo
            let subtitle = '';
            let subtitleLinkHtml = '';
            let subtitleEl = null;
            for (const cls of (profile.subtituloClasses || [])) {
                const el = container.querySelector(`.${cls}`);
                if (el && txt(el)) { subtitle = txt(el); subtitleEl = el; break; }
            }
            if (!subtitleEl) subtitleEl = container.querySelector('.voc-subtitle');
            if (subtitleEl) {
                let sib = subtitleEl.nextElementSibling;
                let steps = 0;
                while (sib && steps < 4 && !subtitleLinkHtml) {
                    if (!isExcluded(sib) && sib.querySelector && sib.querySelector('a[href]')) {
                        const sanitized = sanitizeParagraphInnerHtml(sib);
                        if (sanitized && !isAdCode(sanitized)) {
                            subtitleLinkHtml = sanitized;
                        }
                        break;
                    }
                    sib = sib.nextElementSibling;
                    steps++;
                }
            }

            // Autor
            let author = '';
            // Priorizar nombre expl√≠cito si existe
            const explicitName = container.querySelector('.voc-author__subitem.voc-author__subitem--1 .voc-author__name, .voc-author__name');
            if (explicitName && txt(explicitName)) author = cleanAuthorText(txt(explicitName));
            if (!author) {
                for (const cls of (profile.autorClasses || [])) {
                    const el = container.querySelector(`.${cls}`);
                    if (el && txt(el)) { author = cleanAuthorText(txt(el)); break; }
                }
            }
            if (!author && jsonld) {
                const a = jsonld.author;
                if (Array.isArray(a)) author = a.map(x => x && x.name).filter(Boolean).join(', ');
                else if (a && typeof a === 'object') author = a.name || '';
            }
            if (!author) {
                const m = $('meta[name="author"]');
                if (m) author = m.getAttribute('content') || '';
            }
            if (author) author = cleanAuthorText(author);

            // Foto del autor (si existe)
            const authorPhotoEl = container.querySelector('.voc-author__img, .voc-author__image img, .voc-author__container img, .voc-author__item img, .voc-author__subitem img, .voc-author__subitem--1 img');
            const authorPhoto = authorPhotoEl ? bestImageUrl(authorPhotoEl) : '';

            // Fechas
            const toISO = (v) => { if (!v) return ''; const d = new Date(v); return isNaN(d.getTime()) ? '' : d.toISOString(); };
            let publishedAt = '';
            for (const cls of (profile.fechaPublicacionClasses || [])) {
                const el = container.querySelector(`.${cls} time[datetime], .${cls}`);
                if (el) { publishedAt = toISO(el.getAttribute('datetime') || txt(el)); if (publishedAt) break; }
            }
            if (!publishedAt) publishedAt = toISO(jsonld && jsonld.datePublished) || toISO(meta('property', 'article:published_time'));

            let updatedAt = '';
            for (const cls of (profile.fechaActualizacionClasses || [])) {
                const el = container.querySelector(`.${cls} time[datetime], .${cls}`);
                if (el) { updatedAt = toISO(el.getAttribute('datetime') || txt(el)); if (updatedAt) break; }
            }
            if (!updatedAt) updatedAt = toISO(jsonld && jsonld.dateModified) || toISO(meta('property', 'article:modified_time'));

            // ABC: si existen m√∫ltiples <time datetime=...>, usar la m√°s reciente como updatedAt
            try {
                const timeNodes = Array.from(container.querySelectorAll('time[datetime]'));
                const timestamps = timeNodes
                    .map(t => t.getAttribute('datetime') || txt(t))
                    .map(v => { const d = new Date(v); return isNaN(d.getTime()) ? null : d; })
                    .filter(Boolean)
                    .map(d => d.getTime());
                if (timestamps.length) {
                    const maxTs = Math.max(...timestamps);
                    const minTs = Math.min(...timestamps);
                    const computedUpdated = new Date(maxTs).toISOString();
                    const computedPublished = new Date(minTs).toISOString();
                    // Preferir la m√°s reciente como updatedAt
                    if (!updatedAt) updatedAt = computedUpdated; else {
                        const u = new Date(updatedAt).getTime();
                        if (!isNaN(u) && maxTs > u) updatedAt = computedUpdated;
                    }
                    // Si falta publishedAt, usar la m√°s antigua
                    if (!publishedAt) publishedAt = computedPublished;
                }
            } catch {}

            // Cuerpo (respeta enlaces/negritas): intercalar p√°rrafos <p> y subt√≠tulos en .voc-c-container
            let flowNodes = Array.from(container.querySelectorAll('p, .voc-c-container')).filter(el => txt(el) && !isExcluded(el));
            if (flowNodes.length === 0) {
                // Fallback: buscar bloques de texto dentro del contenedor principal
                flowNodes = Array.from(container.querySelectorAll('div, section, article')).filter(el => {
                    if (isExcluded(el)) return false;
                    const t = txt(el);
                    return t && t.length > 60 && el.querySelectorAll('p').length === 0;
                }).slice(0, 8);
            }
            const bodyParagraphsHtml = flowNodes
                .map(el => {
                    if (el.matches && el.matches('.voc-c-container')) {
                        const h = sanitizeParagraphInnerHtml(el).trim();
                        const plain = h.replace(/<[^>]*>/g,'').trim();
                        if (!plain) return '';
                        return `<strong style="font-size:1.35rem;">${plain}</strong>`;
                    }
                    return sanitizeParagraphInnerHtml(el);
                })
                .filter(h => h && !/https?:\/\/[^\s<]*(twitter\.com|x\.com|t\.co|twimg\.com|pbs\.twimg\.com|video\.twimg\.com)/i.test(h) && !isAdCode(h));
            const bodyParagraphs = bodyParagraphsHtml.map(h => h.replace(/<[^>]*>/g,'').trim());

            // Im√°genes con subt√≠tulos (figcaption)
            const seenImages = new Set();
            const images = [];
            const pushImageObj = (url, caption) => {
                if (!url) return;
                const abs = resolveUrl(url);
                const key = normalizeImageKey(abs);
                if (!abs || seenImages.has(key)) return;
                if (isTwitterLike(abs)) return;
                seenImages.add(key);
                images.push({ url: abs, caption: caption || '' });
            };
            const ogImage = meta('property', 'og:image') || meta('property', 'og:image:url') || meta('property', 'og:image:secure_url') || meta('name', 'twitter:image') || meta('property', 'twitter:image') || meta('name', 'twitter:image:src');
            const figureCaptionSelector = '.voc-figcaption, .voc-figcaption--text, figcaption';
            const findCaptionForImage = (img) => {
                const figureOrContainer = img.closest('figure') || img.closest('.voc-img-figure') || img.closest('.voc-img-container');
                if (figureOrContainer) {
                    const capEl = figureOrContainer.querySelector(figureCaptionSelector);
                    if (capEl && txt(capEl)) return txt(capEl);
                }
                // Buscar en hermanos inmediatos
                let parent = img.parentElement;
                for (let i = 0; i < 3 && parent; i++) {
                    const sibCap = parent.querySelector(figureCaptionSelector);
                    if (sibCap && txt(sibCap)) return txt(sibCap);
                    parent = parent.parentElement;
                }
                // Fallback al atributo alt
                const alt = img.getAttribute('alt');
                if (alt && alt.trim().length > 0) return alt.trim();
                return '';
            };
            const isAuthorRegion = (el) => !!(el.closest('.voc-author') || el.closest("[class*='author']"));
            const isHeaderRegion = (el) => !!(el.closest('.header'));
            for (const cls of (profile.imagenesClasses || [])) {
                container.querySelectorAll(`img.${cls}, .${cls} img`).forEach(img => {
                    if (isAdOrUi(img) || isAuthorRegion(img) || isHeaderRegion(img)) return;
                    const url = bestImageUrl(img);
                    const caption = findCaptionForImage(img);
                    pushImageObj(url, caption);
                });
            }
            // Fallback adicional: <picture><source> sin clases espec√≠ficas
            container.querySelectorAll('picture source[srcset], picture source[data-srcset]').forEach(source => {
                const sset = source.getAttribute('srcset') || source.getAttribute('data-srcset');
                const url = pickBestFromSrcset(sset);
                if (!url) return;
                if (isAdOrUi(source) || isAuthorRegion(source) || isHeaderRegion(source)) return;
                const caption = findCaptionForImage(source.closest('picture') || source);
                pushImageObj(url, caption);
            });
            // Fallback gen√©rico: im√°genes dentro del contenedor por si cambian clases
            if (images.length === 0) {
                container.querySelectorAll('img').forEach(img => {
                    if (isAdOrUi(img) || isAuthorRegion(img) || isHeaderRegion(img)) return;
                    const url = bestImageUrl(img);
                    if (!url) return;
                    const caption = findCaptionForImage(img);
                    pushImageObj(url, caption);
                });
            }
            // Fallback JSON-LD
            if (images.length === 0 && jsonld) {
                const jlImages = [];
                const addJl = (val) => {
                    if (!val) return;
                    if (typeof val === 'string') jlImages.push(val);
                    else if (Array.isArray(val)) val.forEach(x => addJl(x));
                    else if (typeof val === 'object') jlImages.push(val.url || val.contentUrl || val.thumbnail || val.thumbnailUrl || '');
                };
                addJl(jsonld.image);
                addJl(jsonld.thumbnailUrl);
                const jl = jlImages.find(Boolean);
                if (jl) pushImageObj(jl, '');
            }
            // Fallback: si no hay im√°genes en el art√≠culo, usar og:image
            if (images.length === 0 && ogImage) pushImageObj(ogImage, '');

            // V√≠deos
            const videos = [];
            for (const cls of (profile.videosClasses || [])) {
                container.querySelectorAll(`.${cls} video source[src], .${cls} iframe[src]`).forEach(el => {
                    const u = el.getAttribute('src'); if (u) videos.push(resolveUrl(u));
                });
            }
            // Fallback gen√©rico a nativos + YouTube/Vimeo
            container.querySelectorAll('video source[src]').forEach(s => { const u = s.getAttribute('src'); if (u) videos.push(resolveUrl(u)); });
            container.querySelectorAll("iframe[src*='youtube'], iframe[src*='vimeo']").forEach(f => { const u = f.getAttribute('src'); if (u) videos.push(resolveUrl(u)); });
            // Filtrar v√≠deos de dominios Twitter
            const filteredVideos = videos.filter(u => !/(^https?:\/\/)?([\w-]+\.)*(twitter\.com|x\.com|t\.co|twimg\.com|pbs\.twimg\.com|video\.twimg\.com)\//i.test(u));

            return {
                title,
                subtitle,
                subtitleLinkHtml,
                author,
                authorPhoto,
                publishedAt: publishedAt || '',
                updatedAt: updatedAt || '',
                bodyParagraphs,
                bodyParagraphsHtml,
                images,
                videos: filteredVideos
            };
        }
        
        // Inicializar la aplicaci√≥n
        document.addEventListener('DOMContentLoaded', () => {
            new NewsExtractor();
        });
    </script>
</body>
</html>